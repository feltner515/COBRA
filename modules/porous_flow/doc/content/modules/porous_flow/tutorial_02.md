[Start](porous_flow/tutorial_00.md) |
[Previous](porous_flow/tutorial_01.md) |
[Next](porous_flow/tutorial_03.md)

# Porous Flow Tutorial Page 02.  Numerical issues

This tutorial page discusses a number of numerical issues involved in the very simple model presented in [Page 01](porous_flow/tutorial_01.md).  So, you're really only interested in modelling, and not numerical mathematics rubbish?  Unfortunately, *to run PorousFlow effectively, the user must be keenly aware of all these numerical issues,* so it is useful to discuss them in full in such a simple setting.

## Newton nonlinear solves

Many users of MOOSE use the PJFNK method.  This is not recommended in PorousFlow.  Instead, a full Newton solve is recommended.  This is implemented by the `solve_type = Newton` in the `Executioner` block:

!listing modules/porous_flow/examples/tutorial/01.i start=[Executioner] end=[Outputs]

This means that MOOSE uses the Newton-Raphson method (see Wikipedia) to solve the system of equations generated by the DE.  The Jacobian used in this method is the derivative of the residual (the DE) with respect to the Variables (just porepressure in this example).  Much of the PorousFlow code is devoted to computing this Jacobian precisely, so users are strongly encouraged to use it.  It typically improves convergence speed by a few orders of magnitude (although in the simple example of this tutorial page, which is a linear problem, it actually makes little difference).

When using `solve_type = Newton`, the overall solve strategy is:

- Form the residual, by computing the DEs using the current variables.
  The nonlinear tolerances are checked to see if the solution has been
  found.  If not the following steps are taken.

- Form the Jacobian matrix, by computing the derivatives of the DEs
  with respect to the variables, and evaluating using the current
  variables

- Invert the Jacobian matrix.  This is the "linear solve".  It may be
  an iterative process, depending on the flags provided to PETSc.  It
  is deemed successful when certain linear tolerances are met

- Using the inverted Jacobian, update the current variables, employing
  the Newton-Raphson method

- This completes one "nonlinear iteration".  Another nonlinear
  iteration is started from the first step, above.

The two difficulties most commonly encountered are:

- PETSc finds it difficult to invert the Jacobian, ie, the linear
  solve fails or takes thousands of iterations to finally converge.
  This almost definitely means that a stronger preconditioner is
  needed.

- Many nonlinear iterations are needed at each timestep.  This is
  usually because your simulation is highly nonlinear.  Sometimes this
  is simply "too bad", but often it is due to [difficult numerical situations](nonlinear_convergence_problems.md) that can
  be fixed with some careful analysis.


## Nonlinear solves and the Dictator's variables

In this simple example, the `PorousFlowDictator` isn't built explicitly, since it is built internally by the `PorousFlowBasicTHM` `Action`.  However, in many input files you will see something like

!listing modules/porous_flow/test/tests/energy_conservation/heat03.i start=[dictator] end=[pc]

The `PorousFlowDictator` is given the name `dictator` and the number of fluid phases and fluid components are specified.  The `porous_flow_vars` specifies the PorousFlow variables.  *All derivatives with respect to these variables enter the Jacobian, while derivatives with respect to any other Variables are not computed.*  Therefore it is strongly recommended that all Variables are entered into the `porous_flow_vars`, unless there is a good reason to not compute the derivatives with respect to a particular variable.

## Preconditioning and the linear solve

In each nonlinear iteration (as MOOSE slowly converges to the solution for that given timestep) a linear solve must be performed to invert the Jacobian.  Often in PorousFlow simulations, the Jacobian is quite ill conditioned, so a strong precondioner is needed.  Typically, one of two choices are made:

!listing modules/porous_flow/examples/tutorial/01.i start=[Preconditioning] end=[Executioner]

More remarks can be found in [Preconditioning and solvers](porous_flow/solvers.md).  The PorousFlow tests and examples use some alternative preconditioners, and users struggling with convergence of the linear solve may like to explore those, but the two methods shown above work nicely in most cases.

In the simple example studied in this page, the `Preconditioning` makes very little difference, but in full-scale nonlinear PorousFlow simulations it can decrease or increase solve times by orders of magnitude.

## Linear and nonlinear tolerances

A detailed discussion of setting the nonlinear tolerances may be found in [convergence criteria](porous_flow/convergence.md).  For single-phase simulation of this tutorial chapter, the residual is
\begin{equation}
R \approx V|\kappa|\epsilon /\mu \approx 10^{-11} V\epsilon
\end{equation}
(The missing factor of $\rho_{0}$ between this formula and that in [convergence criteria](porous_flow/convergence.md) is because the DE solved in thie Page does not multiply by density, which is unusual for PorousFlow.)  Here $V$ is the volume of the "interesting region" in the model, and $\epsilon$ is the tolerable error in $\nabla P$.  Supposing that the "interesting region" is the $1\times 1\times 4\,$m$^{3}$ surrounding the borehole, and a tolerable error is 1$\,$Pa.m$^{-1}$, this yields $R\approx 10^{-10}$.  This provides a rough estimate for the nonlinear residual in the `Executioner` block:

!listing modules/porous_flow/examples/tutorial/01.i start=[Executioner] end=[Outputs]

## Numerical stabilization

A very careful reader will have noticed that during the simulation the porepressure falls below its initial value of 0: look again at the scale on the resulting animation shown in [the previous page](porous_flow/tutorial_01.md).  This is completely unphysical.

This is purely a numerical issue that occurs in all simple-minded finite-element (and finite-difference) simulations, and is discussed in the [numerical stabilization](porous_flow/stabilization.md) page.  In later tutorial pages, numerical stabilization will be employed, since it is the default in most of PorousFlow, but let us ignore this issue for now.

[Start](porous_flow/tutorial_00.md) |
[Previous](porous_flow/tutorial_01.md) |
[Next](porous_flow/tutorial_03.md)
